<!DOCTYPE html><html lang="en"><head><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com https://wbzxptorxaszkrodlogg.supabase.co; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Track Packages - FedEx</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@300;400;600;700&amp;display=swap" rel="stylesheet">
  
  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            'fedex-purple': '#4D148C',
            'fedex-orange': '#FF6200',
            'fedex-gray': '#767676',
            'fedex-light-gray': '#F5F5F5',
            'fedex-dark-gray': '#333333',
            'fedex-blue': '#0071CE',
            'fedex-green': '#6CBF00'
          },
          fontFamily: {
            'fedex': ['Source Sans Pro', 'Arial', 'sans-serif']
          }
        }
      }
    }
  </script>

  <style>
    * {
      font-family: 'Source Sans Pro', Arial, sans-serif;
    }

    .fedex-shadow {
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .fedex-button {
      background: #4D148C;
      transition: all 0.3s ease;
    }

    .fedex-button:hover {
      background: #3D0F6B;
      transform: translateY(-1px);
    }

    .fedex-button:disabled {
      background: #9CA3AF;
      transform: none;
      cursor: not-allowed;
    }

    .progress-container {
      position: relative;
      background: #E5E7EB;
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-bar {
      background: linear-gradient(90deg, #FF6200, #4D148C);
      height: 100%;
      border-radius: 4px;
      transition: width 2s ease-in-out;
      position: relative;
    }

    .progress-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .progress-step {
      position: relative;
      z-index: 2;
    }

    .progress-step::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 100%;
      width: 100%;
      height: 3px;
      background: #E5E7EB;
      z-index: 1;
      transform: translateY(-50%);
    }

    .progress-step.completed::after {
      background: #6CBF00;
    }

    .progress-step.current::after {
      background: linear-gradient(90deg, #FF6200, #E5E7EB);
    }

    .progress-step:last-child::after {
      display: none;
    }

    .modal-backdrop {
      backdrop-filter: blur(4px);
    }

    .page-section {
      display: none;
    }

    .page-section.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .animate-fade-in {
      animation: fadeIn 0.5s ease-out;
    }

    .timeline-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      position: absolute;
      left: -6px;
      top: 6px;
    }

    .timeline-line {
      width: 2px;
      background: #E5E7EB;
      position: absolute;
      left: -1px;
      top: 18px;
      bottom: -18px;
    }

    .timeline-item:last-child .timeline-line {
      display: none;
    }

    .map-container {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      position: relative;
      overflow: hidden;
    }

    .route-line {
      position: absolute;
      top: 50%;
      left: 10%;
      right: 10%;
      height: 4px;
      background: linear-gradient(90deg, #4D148C, #FF6200, #6CBF00);
      border-radius: 2px;
      transform: translateY(-50%);
    }

    .route-marker {
      position: absolute;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      top: 50%;
      transform: translateY(-50%);
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      border: 2px solid white;
    }

    .route-marker.origin {
      left: 10%;
      background: #4D148C;
    }

    .route-marker.current {
      left: 10%;
      background: #FF6200;
      animation: pulse 2s infinite;
    }

    .route-marker.destination {
      right: 10%;
      background: #6CBF00;
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(255, 98, 0, 0.7); }
      50% { box-shadow: 0 0 0 15px rgba(255, 98, 0, 0); }
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-registered {
      background: #FEF3C7;
      color: #B45309;
      border: 1px solid #FCD34D;
    }

    .status-awaiting-clearance {
      background: #FECACA;
      color: #B91C1C;
      border: 1px solid #FCA5A5;
    }

    .status-in-transit {
      background: #DBEAFE;
      color: #1E40AF;
      border: 1px solid #93C5FD;
    }

    .status-delivered {
      background: #D1FAE5;
      color: #065F46;
      border: 1px solid #6EE7B7;
    }

    .clearance-notice {
      background: linear-gradient(135deg, #FEF3C7, #FDE68A);
      border-left: 4px solid #F59E0B;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      z-index: 1000;
      animation: slideInRight 0.5s ease-out;
      max-width: 350px;
    }

    .notification.success { background: #059669; }
    .notification.error { background: #DC2626; }
    .notification.info { background: #0284C7; }
    .notification.warning { background: #D97706; }

    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #FF6200;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .service-card {
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .service-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .faq-item {
      border-bottom: 1px solid #E5E7EB;
      cursor: pointer;
    }

    .faq-answer {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .faq-answer.active {
      max-height: 200px;
    }

    .typing-indicator {
      display: inline-block;
    }

    .typing-indicator::after {
      content: '|';
      animation: blink 1s infinite;
    }

    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }

    /* Tab Navigation */
    .tab-button {
      padding: 0.75rem 1.5rem;
      border-bottom: 2px solid transparent;
      transition: all 0.3s ease;
    }

    .tab-button.active {
      border-bottom-color: #FF6200;
      color: #4D148C;
      font-weight: 600;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Form Error States */
    .error-text {
      display: block;
      animation: fadeIn 0.3s ease-out;
    }

    /* Accessibility Focus */
    .modal-content:focus {
      outline: 2px solid #4D148C;
      outline-offset: 2px;
    }

    /* FAQ Animation */
    .faq-item .fa-chevron-up {
      transform: rotate(180deg);
      transition: transform 0.3s ease;
    }

    /* Real-time status indicator */
    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #6CBF00;
      animation: pulse-status 2s infinite;
    }

    @keyframes pulse-status {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    @media (max-width: 768px) {
      .modal-content {
        width: 95%;
        max-height: 85vh;
        margin: 2rem;
      }
      .progress-step h4 {
        font-size: 0.75rem;
      }
      .progress-step p {
        font-size: 0.65rem;
      }
      .timeline-item {
        padding-left: 2rem;
      }
      .timeline-dot {
        left: -4px;
      }
    }

    @media (max-width: 640px) {
      .modal-content {
        width: 100%;
        height: 100vh;
        max-height: 100vh;
        border-radius: 0;
        margin: 0;
      }
      
      .grid.lg\\:grid-cols-2 {
        grid-template-columns: 1fr;
      }
      
      .flex.space-x-3 {
        flex-direction: column;
        align-items: stretch;
      }
      
      .flex.space-x-3 > * {
        margin-bottom: 0.75rem;
      }
      
      .map-container {
        height: 200px !important;
      }
    }
  </style>
</head>

<body class="bg-white font-fedex">
  <!-- Header -->
  <header class="bg-white border-b border-gray-200 sticky top-0 z-40">
    <!-- Top Bar -->
    <div class="bg-fedex-purple text-white py-1">
      <div class="max-w-7xl mx-auto px-4 flex justify-between items-center text-sm">
        <div class="flex space-x-4">
          <span>United States | English</span>
          <span class="status-indicator"></span>
          <span>Live System</span>
        </div>
        <div class="flex space-x-4">
          <a href="#" class="hover:text-fedex-orange" onclick="showModal('support-modal')">Support</a>
          <a href="#" class="hover:text-fedex-orange" onclick="showModal('contact-modal')">Contact</a>
          <a href="#" class="hover:text-fedex-orange" onclick="showModal('locations-modal')">Locations</a>
        </div>
      </div>
    </div>

    <!-- Main Header -->
    <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <!-- FedEx Logo -->
        <div class="flex items-center cursor-pointer" onclick="showPage('main')">
          <div class="bg-fedex-purple text-white px-3 py-2 font-bold text-2xl">Fed</div>
          <div class="bg-fedex-orange text-white px-3 py-2 font-bold text-2xl">Ex</div>
        </div>

        <!-- Navigation -->
        <nav class="hidden lg:flex space-x-8">
          <a href="#" class="text-fedex-dark-gray hover:text-fedex-purple font-semibold" onclick="showModal('ship-modal')">Ship</a>
          <a href="#" class="text-fedex-purple font-semibold border-b-2 border-fedex-orange pb-3" onclick="showPage('main')">Track</a>
          <a href="#" class="text-fedex-dark-gray hover:text-fedex-purple font-semibold" onclick="showModal('manage-modal')">Manage</a>
          <a href="#" class="text-fedex-dark-gray hover:text-fedex-purple font-semibold" onclick="showModal('support-modal')">Support</a>
        </nav>

        <!-- Mobile Menu -->
        <button class="lg:hidden p-2" onclick="toggleMobileMenu()">
          <i class="fas fa-bars text-2xl text-fedex-dark-gray"></i>
        </button>
      </div>
    </div>
  </header>

  <!-- Mobile Menu -->
  <div id="mobile-menu" class="lg:hidden bg-white border-b border-gray-200 hidden">
    <div class="px-4 py-2 space-y-2">
      <a href="#" class="block py-2 text-fedex-dark-gray hover:text-fedex-purple" onclick="showModal('ship-modal'); hideMobileMenu();">Ship</a>
      <a href="#" class="block py-2 text-fedex-purple font-semibold" onclick="showPage('main'); hideMobileMenu();">Track</a>
      <a href="#" class="block py-2 text-fedex-dark-gray hover:text-fedex-purple" onclick="showModal('manage-modal'); hideMobileMenu();">Manage</a>
      <a href="#" class="block py-2 text-fedex-dark-gray hover:text-fedex-purple" onclick="showModal('support-modal'); hideMobileMenu();">Support</a>
      <a href="#" class="block py-2 text-fedex-dark-gray hover:text-fedex-purple" onclick="showModal('contact-modal'); hideMobileMenu();">Contact</a>
      <a href="#" class="block py-2 text-fedex-dark-gray hover:text-fedex-purple" onclick="showModal('locations-modal'); hideMobileMenu();">Locations</a>
    </div>
  </div>

  <!-- Main Content Container -->
  <div id="content-container">
    <!-- MAIN TRACKING PAGE -->
    <div id="main-page" class="page-section active">
      <main class="min-h-screen bg-fedex-light-gray">
        <!-- Hero Section -->
        <section class="bg-white py-12">
          <div class="max-w-6xl mx-auto px-4">
            <div class="text-center mb-8">
              <h1 class="text-4xl font-bold text-fedex-dark-gray mb-4">Track Your Package</h1>
              <p class="text-xl text-fedex-gray">Enter your tracking number to get real-time updates</p>
            </div>

            <!-- Tracking Form -->
            <div class="max-w-2xl mx-auto">
              <div class="bg-white border border-gray-200 rounded-lg fedex-shadow p-6">
                <form id="tracking-form">
                  <div class="mb-4">
                    <label class="block text-lg font-semibold text-fedex-dark-gray mb-3">
                      Track by tracking number
                    </label>
                    <div class="relative">
                      <input type="text" id="tracking-number" required="" class="w-full px-4 py-4 text-lg border-2 border-gray-300 rounded-lg focus:border-fedex-purple focus:outline-none transition-colors" placeholder="Enter tracking number (e.g., FD26031998KR)">
                      <button type="submit" id="track-button" class="absolute right-2 top-2 fedex-button text-white px-6 py-2 rounded-lg font-semibold hover:bg-fedex-dark-gray transition-colors">
                        <span id="track-text">Track</span>
                        <span id="track-loading" class="hidden"><div class="loading-spinner"></div></span>
                      </button>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </section>

        <!-- Real-time Stats Dashboard -->
        <section class="py-12 bg-white">
          <div class="max-w-6xl mx-auto px-4">
            <h2 class="text-2xl font-bold text-fedex-dark-gray mb-6">Live Package Statistics</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
              <div class="bg-gradient-to-br from-fedex-purple to-blue-600 text-white rounded-lg p-6">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-lg font-bold">Active Packages</h3>
                  <i class="fas fa-box text-2xl opacity-75"></i>
                </div>
                <p class="text-3xl font-bold mb-2" id="active-packages-count">0</p>
                <p class="text-sm opacity-90">Currently in system</p>
              </div>

              <div class="bg-gradient-to-br from-fedex-orange to-red-500 text-white rounded-lg p-6">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-lg font-bold">Clearance Requests</h3>
                  <i class="fas fa-clipboard-check text-2xl opacity-75"></i>
                </div>
                <p class="text-3xl font-bold mb-2" id="clearance-requests-count">0</p>
                <p class="text-sm opacity-90">Pending approval</p>
              </div>

              <div class="bg-gradient-to-br from-fedex-green to-green-600 text-white rounded-lg p-6">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-lg font-bold">Delivered Today</h3>
                  <i class="fas fa-check-circle text-2xl opacity-75"></i>
                </div>
                <p class="text-3xl font-bold mb-2" id="delivered-today-count">0</p>
                <p class="text-sm opacity-90">Successfully delivered</p>
              </div>

              <div class="bg-gradient-to-br from-fedex-blue to-blue-700 text-white rounded-lg p-6">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-lg font-bold">Locations</h3>
                  <i class="fas fa-map-marker-alt text-2xl opacity-75"></i>
                </div>
                <p class="text-3xl font-bold mb-2" id="locations-count">0</p>
                <p class="text-sm opacity-90">Worldwide facilities</p>
              </div>
            </div>
          </div>
        </section>

        <!-- Services Quick Links -->
        <section class="py-12">
          <div class="max-w-6xl mx-auto px-4">
            <h2 class="text-3xl font-bold text-fedex-dark-gray text-center mb-8">Our Services</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div class="service-card bg-white rounded-lg fedex-shadow p-6 text-center" onclick="showModal('ship-modal')">
                <div class="w-16 h-16 bg-fedex-purple rounded-full flex items-center justify-center mx-auto mb-4">
                  <i class="fas fa-shipping-fast text-white text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-fedex-dark-gray mb-2">Ship</h3>
                <p class="text-fedex-gray">Create shipping labels and schedule pickups</p>
              </div>

              <div class="service-card bg-white rounded-lg fedex-shadow p-6 text-center" onclick="showPage('main')">
                <div class="w-16 h-16 bg-fedex-orange rounded-full flex items-center justify-center mx-auto mb-4">
                  <i class="fas fa-search text-white text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-fedex-dark-gray mb-2">Track</h3>
                <p class="text-fedex-gray">Monitor your shipments in real-time</p>
              </div>

              <div class="service-card bg-white rounded-lg fedex-shadow p-6 text-center" onclick="showModal('manage-modal')">
                <div class="w-16 h-16 bg-fedex-blue rounded-full flex items-center justify-center mx-auto mb-4">
                  <i class="fas fa-cog text-white text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-fedex-dark-gray mb-2">Manage</h3>
                <p class="text-fedex-gray">Access your shipping history and preferences</p>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Tracking Modal -->
  <div id="tracking-modal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden items-center justify-center z-50 p-2 sm:p-4">
    <div class="bg-white rounded-lg w-full max-w-7xl max-h-[95vh] overflow-y-auto animate-fade-in modal-content">
      <!-- Modal Header -->
      <div class="bg-fedex-purple text-white p-4 sm:p-6 rounded-t-lg sticky top-0 z-10">
        <div class="flex justify-between items-center">
          <div>
            <h2 class="text-xl sm:text-2xl font-bold">Tracking Details</h2>
            <p class="text-fedex-orange text-sm sm:text-lg font-semibold" id="modal-tracking-number">Loading...</p>
          </div>
          <button id="close-modal" class="text-white hover:text-fedex-orange text-xl sm:text-2xl">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>

      <!-- Modal Content -->
      <div class="p-4 sm:p-6" id="modal-content">
        <div class="flex justify-center items-center py-12">
          <div class="loading-spinner mr-3"></div>
          <span>Loading package information...</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Clearance Modal -->
  <div id="clearance-modal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto animate-fade-in modal-content">
      <div class="bg-fedex-purple text-white p-6 rounded-t-lg">
        <div class="flex justify-between items-center">
          <h2 class="text-2xl font-bold">Package Clearance Request</h2>
          <button id="close-clearance-modal" class="text-white hover:text-fedex-orange text-2xl">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <div class="p-6">
        <h3 class="text-xl font-bold text-fedex-dark-gray mb-4">Request Package Clearance</h3>
        <p class="text-fedex-gray mb-6">Your package requires clearance approval before shipping can proceed to your destination.</p>
        <form id="clearance-form">
          <input type="hidden" id="clearance-tracking-number" value="">
          <div class="space-y-4">
            <div>
              <label class="block text-fedex-dark-gray font-semibold mb-2">Full Name</label>
              <input type="text" name="full_name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:border-fedex-purple focus:outline-none" placeholder="Enter your full name" required="">
            </div>
            <div>
              <label class="block text-fedex-dark-gray font-semibold mb-2">Email Address</label>
              <input type="email" name="email" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:border-fedex-purple focus:outline-none" placeholder="your@email.com" required="">
            </div>
            <div>
              <label class="block text-fedex-dark-gray font-semibold mb-2">Phone Number</label>
              <input type="tel" name="phone" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:border-fedex-purple focus:outline-none" placeholder="Enter your phone number" required="">
            </div>
            <div>
              <label class="block text-fedex-dark-gray font-semibold mb-2">Address</label>
              <textarea name="address" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:border-fedex-purple focus:outline-none" placeholder="Your complete address" required=""></textarea>
            </div>
            <div>
              <label class="block text-fedex-dark-gray font-semibold mb-2">Additional Notes</label>
              <textarea name="notes" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:border-fedex-purple focus:outline-none" placeholder="Any additional information..."></textarea>
            </div>
          </div>
          
          <div class="flex justify-end space-x-3 mt-6">
            <button type="button" id="cancel-clearance" class="border border-gray-300 text-fedex-dark-gray px-6 py-3 rounded-lg font-semibold">
              Cancel
            </button>
            <button type="submit" class="fedex-button text-white px-6 py-3 rounded-lg font-semibold">
              <span id="clearance-submit-text">Submit Clearance Request</span>
              <span id="clearance-submit-loading" class="hidden"><div class="loading-spinner"></div></span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Ship Modal -->
  <div id="ship-modal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto animate-fade-in modal-content">
      <div class="bg-fedex-purple text-white p-6 rounded-t-lg">
        <div class="flex justify-between items-center">
          <h2 class="text-2xl font-bold">Ship with FedEx</h2>
          <button onclick="closeModal('ship-modal')" class="text-white hover:text-fedex-orange text-2xl">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <div class="p-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <div>
            <h3 class="text-xl font-bold text-fedex-purple mb-4">Create a Shipment</h3>
            <div class="space-y-4">
              <div class="border border-gray-200 rounded-lg p-4 hover:border-fedex-purple transition-colors cursor-pointer">
                <h4 class="font-bold text-fedex-dark-gray mb-2">Domestic Shipping</h4>
                <p class="text-fedex-gray text-sm">Ship within the United States with our comprehensive domestic services.</p>
              </div>
              <div class="border border-gray-200 rounded-lg p-4 hover:border-fedex-purple transition-colors cursor-pointer">
                <h4 class="font-bold text-fedex-dark-gray mb-2">International Shipping</h4>
                <p class="text-fedex-gray text-sm">Ship worldwide with our international shipping solutions.</p>
              </div>
            </div>
            <button class="fedex-button text-white px-6 py-3 rounded-lg font-semibold mt-6 w-full" onclick="createNewShipment()">
              Create Shipment
            </button>
          </div>
          <div>
            <h3 class="text-xl font-bold text-fedex-purple mb-4">Quick Ship Calculator</h3>
            <form id="ship-calculator-form">
              <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-fedex-dark-gray font-semibold mb-2">From ZIP</label>
                    <input type="text" name="from_zip" class="w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="90210" required="">
                  </div>
                  <div>
                    <label class="block text-fedex-dark-gray font-semibold mb-2">To ZIP</label>
                    <input type="text" name="to_zip" class="w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="10001" required="">
                  </div>
                </div>
                <div>
                  <label class="block text-fedex-dark-gray font-semibold mb-2">Weight (lbs)</label>
                  <input type="number" name="weight" class="w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="5" required="">
                </div>
                <button type="submit" class="fedex-button text-white px-6 py-3 rounded-lg font-semibold w-full">
                  Calculate Rate
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced Support Modal with Real FAQ -->
  <div id="support-modal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto animate-fade-in modal-content">
      <div class="bg-fedex-purple text-white p-6 rounded-t-lg">
        <div class="flex justify-between items-center">
          <h2 class="text-2xl font-bold">Customer Support</h2>
          <button onclick="closeModal('support-modal')" class="text-white hover:text-fedex-orange text-2xl" aria-label="Close Support Modal">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <div class="p-6">
        <div class="flex space-x-4 mb-6">
          <button class="tab-button active" data-tab="contact" onclick="showTab('contact')">Contact</button>
          <button class="tab-button" data-tab="quick-help" onclick="showTab('quick-help')">Quick Help</button>
          <button class="tab-button" data-tab="faq" onclick="showTab('faq')">FAQ</button>
        </div>
        <div id="contact" class="tab-content active">
          <h3 class="text-xl font-bold text-fedex-purple mb-4">Contact Information</h3>
          <div class="space-y-4">
            <div class="flex items-center space-x-3">
              <i class="fas fa-phone text-fedex-orange"></i>
              <div>
                <p class="font-semibold"><a href="tel:1-800-GO-FEDEX">1-800-GO-FEDEX</a> (<a href="tel:1-800-463-3339">1-800-463-3339</a>)</p>
                <p class="text-sm text-fedex-gray">Available 24/7</p>
              </div>
            </div>
            <div class="flex items-center space-x-3">
              <i class="fas fa-envelope text-fedex-orange"></i>
              <div>
                <p class="font-semibold"><a href="mailto:helpfedexparcel@gmail.com">helpfedexparcel@gmail.com</a></p>
                <p class="text-sm text-fedex-gray">Response within 24 hours</p>
              </div>
            </div>
            <div class="flex items-center space-x-3">
              <i class="fas fa-comments text-fedex-orange"></i>
              <div>
                <p class="font-semibold">Live Chat</p>
                <button class="text-sm text-fedex-purple hover:underline" onclick="openLiveChat()" aria-label="Start Live Chat">Start Chat</button>
              </div>
            </div>
          </div>
        </div>
        <div id="quick-help" class="tab-content">
          <h3 class="text-xl font-bold text-fedex-purple mb-4">Quick Help</h3>
          <div class="space-y-3">
            <div class="p-3 border border-gray-200 rounded-lg hover:border-fedex-purple transition-colors cursor-pointer" onclick="showPage('main')">
              <h4 class="font-semibold">Track a Package</h4>
              <p class="text-sm text-fedex-gray">Get real-time updates on your shipment</p>
            </div>
            <div class="p-3 border border-gray-200 rounded-lg hover:border-fedex-purple transition-colors cursor-pointer" onclick="showModal('ship-modal')">
              <h4 class="font-semibold">Shipping Rates</h4>
              <p class="text-sm text-fedex-gray">Calculate shipping costs and transit times</p>
            </div>
            <div class="p-3 border border-gray-200 rounded-lg hover:border-fedex-purple transition-colors cursor-pointer" onclick="showModal('locations-modal')">
              <h4 class="font-semibold">Find Locations</h4>
              <p class="text-sm text-fedex-gray">Locate nearby FedEx facilities</p>
            </div>
          </div>
        </div>
        <div id="faq" class="tab-content">
          <h3 class="text-xl font-bold text-fedex-purple mb-4">Frequently Asked Questions</h3>
          <div id="faq-container">
            <!-- FAQ items loaded from database -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Contact Modal -->
  <div id="contact-modal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto animate-fade-in modal-content">
      <div class="bg-fedex-purple text-white p-6 rounded-t-lg">
        <div class="flex justify-between items-center">
          <h2 class="text-2xl font-bold">Contact FedEx</h2>
          <button onclick="closeModal('contact-modal')" class="text-white hover:text-fedex-orange text-2xl">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <div class="p-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <div>
            <h3 class="text-xl font-bold text-fedex-purple mb-4">Get in Touch</h3>
            <form id="contact-form">
              <div class="space-y-4">
                <div>
                  <label class="block text-fedex-dark-gray font-semibold mb-2">Full Name</label>
                  <input type="text" name="full_name" class="w-full px-4 py-3 border border-gray-300 rounded-lg" required="">
                </div>
                <div>
                  <label class="block text-fedex-dark-gray font-semibold mb-2">Email</label>
                  <input type="email" name="email" class="w-full px-4 py-3 border border-gray-300 rounded-lg" required="">
                </div>
                <div>
                  <label class="block text-fedex-dark-gray font-semibold mb-2">Subject</label>
                  <select name="subject" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                    <option>General Inquiry</option>
                    <option>Tracking Issue</option>
                    <option>Billing Question</option>
                    <option>Shipping Problem</option>
                  </select>
                </div>
                <div>
                  <label class="block text-fedex-dark-gray font-semibold mb-2">Message</label>
                  <textarea name="message" rows="5" class="w-full px-4 py-3 border border-gray-300 rounded-lg" required=""></textarea>
                </div>
                <button type="submit" class="fedex-button text-white px-6 py-3 rounded-lg font-semibold w-full">
                  <span id="contact-submit-text">Send Message</span>
                  <span id="contact-submit-loading" class="hidden"><div class="loading-spinner"></div></span>
                </button>
              </div>
            </form>
          </div>
          <div>
            <h3 class="text-xl font-bold text-fedex-purple mb-4">Office Locations</h3>
            <div class="space-y-4">
              <div class="p-4 border border-gray-200 rounded-lg">
                <h4 class="font-bold text-fedex-dark-gray">Corporate Headquarters</h4>
                <p class="text-fedex-gray">942 South Shady Grove Road</p>
                <p class="text-fedex-gray">Memphis, TN 38120</p>
                <p class="text-fedex-gray">Phone: <a href="tel:(901) 818-7500">(901) 818-7500</a></p>
              </div>
              <div class="p-4 border border-gray-200 rounded-lg">
                <h4 class="font-bold text-fedex-dark-gray">International Hub - Paris</h4>
                <p class="text-fedex-gray">15 Rue de la Paix</p>
                <p class="text-fedex-gray">75001 Paris, France</p>
                <p class="text-fedex-gray">Phone: <a href="tel:+33 1 42 61 50 50">+33 1 42 61 50 50</a></p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced Locations Modal with Real Search -->
  <div id="locations-modal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto animate-fade-in modal-content">
      <div class="bg-fedex-purple text-white p-6 rounded-t-lg">
        <div class="flex justify-between items-center">
          <h2 class="text-2xl font-bold">Find FedEx Locations</h2>
          <button onclick="closeModal('locations-modal')" class="text-white hover:text-fedex-orange text-2xl" aria-label="Close Locations Modal">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <div class="p-6">
        <form id="location-search-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <input type="text" id="location-input" name="search_query" class="px-4 py-3 border border-gray-300 rounded-lg" placeholder="ZIP Code or City" aria-label="Enter ZIP Code or City">
          <select name="radius" class="px-4 py-3 border border-gray-300 rounded-lg" aria-label="Select Search Radius">
            <option value="5">5 miles</option>
            <option value="10">10 miles</option>
            <option value="25">25 miles</option>
          </select>
          <button type="submit" class="fedex-button text-white px-6 py-3 rounded-lg font-semibold">
            <span id="location-search-text">Find</span>
            <span id="location-search-loading" class="hidden"><div class="loading-spinner"></div></span>
          </button>
        </form>
        <div id="location-results" class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Results populated from database -->
        </div>
      </div>
    </div>
  </div>

  <!-- Manage Modal -->
  <div id="manage-modal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto animate-fade-in modal-content">
      <div class="bg-fedex-purple text-white p-6 rounded-t-lg">
        <div class="flex justify-between items-center">
          <h2 class="text-2xl font-bold">Manage Your Account</h2>
          <button onclick="closeModal('manage-modal')" class="text-white hover:text-fedex-orange text-2xl">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <div class="text-center p-4 border border-gray-200 rounded-lg hover:border-fedex-purple transition-colors">
            <i class="fas fa-history text-fedex-orange text-3xl mb-3"></i>
            <h3 class="font-bold text-fedex-dark-gray mb-2">Shipping History</h3>
            <p class="text-fedex-gray text-sm">View your past shipments and tracking details</p>
          </div>
          <div class="text-center p-4 border border-gray-200 rounded-lg hover:border-fedex-purple transition-colors">
            <i class="fas fa-user-cog text-fedex-orange text-3xl mb-3"></i>
            <h3 class="font-bold text-fedex-dark-gray mb-2">Account Settings</h3>
            <p class="text-fedex-gray text-sm">Update your profile and preferences</p>
          </div>
          <div class="text-center p-4 border border-gray-200 rounded-lg hover:border-fedex-purple transition-colors">
            <i class="fas fa-address-book text-fedex-orange text-3xl mb-3"></i>
            <h3 class="font-bold text-fedex-dark-gray mb-2">Address Book</h3>
            <p class="text-fedex-gray text-sm">Manage your shipping addresses</p>
          </div>
          <div class="text-center p-4 border border-gray-200 rounded-lg hover:border-fedex-purple transition-colors">
            <i class="fas fa-file-invoice text-fedex-orange text-3xl mb-3"></i>
            <h3 class="font-bold text-fedex-dark-gray mb-2">Billing &amp; Invoices</h3>
            <p class="text-fedex-gray text-sm">View billing information and invoices</p>
          </div>
          <div class="text-center p-4 border border-gray-200 rounded-lg hover:border-fedex-purple transition-colors">
            <i class="fas fa-bell text-fedex-orange text-3xl mb-3"></i>
            <h3 class="font-bold text-fedex-dark-gray mb-2">Notifications</h3>
            <p class="text-fedex-gray text-sm">Manage your notification preferences</p>
          </div>
          <div class="text-center p-4 border border-gray-200 rounded-lg hover:border-fedex-purple transition-colors">
            <i class="fas fa-shield-alt text-fedex-orange text-3xl mb-3"></i>
            <h3 class="font-bold text-fedex-dark-gray mb-2">Security</h3>
            <p class="text-fedex-gray text-sm">Update password and security settings</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Live Chat Modal -->
  <div id="chat-modal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg max-w-md w-full h-96 flex flex-col">
      <div class="bg-fedex-purple text-white p-4 rounded-t-lg">
        <div class="flex justify-between items-center">
          <h3 class="font-bold">Live Chat Support</h3>
          <button onclick="closeModal('chat-modal')" class="text-white hover:text-fedex-orange">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      
      <div class="flex-1 p-4 overflow-y-auto" id="chat-messages">
        <div class="mb-4">
          <div class="bg-gray-100 rounded-lg p-3 mb-2">
            <p class="text-sm"><strong>Support Agent:</strong> Hello! How can I help you today?</p>
          </div>
        </div>
      </div>
      
      <div class="p-4 border-t">
        <form id="chat-form">
          <div class="flex space-x-2">
            <input type="text" id="chat-input" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:border-fedex-purple focus:outline-none" placeholder="Type your message...">
            <button type="submit" class="fedex-button text-white px-4 py-2 rounded-lg">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Additional Footer Modals (simplified for brevity) -->
  <div id="about-modal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto animate-fade-in modal-content">
      <div class="bg-fedex-purple text-white p-6 rounded-t-lg">
        <div class="flex justify-between items-center">
          <h2 class="text-2xl font-bold">About FedEx</h2>
          <button onclick="closeModal('about-modal')" class="text-white hover:text-fedex-orange text-2xl">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <div class="p-6">
        <h3 class="text-xl font-bold text-fedex-purple mb-4">Our Mission</h3>
        <p class="text-fedex-gray mb-6">FedEx connects people and possibilities around the world. We provide customers and businesses worldwide with a broad portfolio of transportation, e-commerce and business services.</p>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-fedex-dark-gray text-white py-12">
    <div class="max-w-6xl mx-auto px-4">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
        <div>
          <div class="flex items-center mb-4 cursor-pointer" onclick="showPage('main')">
            <div class="bg-fedex-purple text-white px-2 py-1 font-bold text-lg">Fed</div>
            <div class="bg-fedex-orange text-white px-2 py-1 font-bold text-lg">Ex</div>
          </div>
          <p class="text-gray-300">Connecting people and possibilities around the world.</p>
        </div>

        <div>
          <h4 class="font-bold text-lg mb-4">Our Company</h4>
          <ul class="space-y-2 text-gray-300">
            <li><a href="#" class="hover:text-fedex-orange" onclick="showModal('about-modal')">About FedEx</a></li>
            <li><a href="#" class="hover:text-fedex-orange" onclick="showModal('investors-modal')">Investor Relations</a></li>
            <li><a href="#" class="hover:text-fedex-orange" onclick="showModal('careers-modal')">Careers</a></li>
            <li><a href="#" class="hover:text-fedex-orange" onclick="showModal('sustainability-modal')">Sustainability</a></li>
          </ul>
        </div>

        <div>
          <h4 class="font-bold text-lg mb-4">Support</h4>
          <ul class="space-y-2 text-gray-300">
            <li><a href="#" class="hover:text-fedex-orange" onclick="showModal('support-modal')">Customer Support</a></li>
            <li><a href="#" class="hover:text-fedex-orange" onclick="showModal('locations-modal')">Find Locations</a></li>
            <li><a href="#" class="hover:text-fedex-orange" onclick="showModal('service-guide-modal')">Service Guide</a></li>
            <li><a href="#" class="hover:text-fedex-orange" onclick="showModal('shipping-tools-modal')">Shipping Tools</a></li>
          </ul>
        </div>

        <div>
          <h4 class="font-bold text-lg mb-4">Connect</h4>
          <div class="flex space-x-4 mb-4">
            <a href="#" class="text-gray-300 hover:text-fedex-orange text-xl">
              <i class="fab fa-facebook"></i>
            </a>
            <a href="#" class="text-gray-300 hover:text-fedex-orange text-xl">
              <i class="fab fa-twitter"></i>
            </a>
            <a href="#" class="text-gray-300 hover:text-fedex-orange text-xl">
              <i class="fab fa-linkedin"></i>
            </a>
            <a href="#" class="text-gray-300 hover:text-fedex-orange text-xl">
              <i class="fab fa-instagram"></i>
            </a>
          </div>
          <div class="text-gray-300">
            <p class="text-sm">Emergency Support:</p>
            <p class="font-semibold">1-800-FEDEX-911</p>
          </div>
        </div>
      </div>

      <div class="border-t border-gray-600 mt-8 pt-8 text-center">
        <p class="text-gray-300">¬© 2025 FedEx Corporation. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <script>
    // üöÄ SUPABASE INTEGRATION - Full Backend Connection
    
    // Initialize Supabase client
    const supabaseUrl = 'https://wbzxptorxaszkrodlogg.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndienhwdG9yeGFzemtyb2Rsb2dnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIxNTU4MDEsImV4cCI6MjA2NzczMTgwMX0.GXTgkDCPQhhJdQ0CkD6QuQgUeiFlZB8ithbR0PtH4iY';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // Application State with Real-time Subscriptions
    const AppState = {
      currentPage: 'main',
      trackingData: {},
      notifications: [],
      chatMessages: [],
      isInitialized: false,
      subscriptions: []
    };

    // Dark mode detection
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.documentElement.classList.add('dark');
    }
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
      if (event.matches) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    });

    // üéØ DATABASE INITIALIZATION AND SAMPLE DATA
    async function initializeDatabase() {
      console.log('üîÑ Initializing FedEx database with sample data...');
      
      try {
        // Initialize sample packages
        await initializeSamplePackages();
        
        // Initialize sample locations
        await initializeSampleLocations();
        
        // Initialize FAQ data
        await initializeFAQData();
        
        // Setup real-time subscriptions
        setupRealTimeSubscriptions();
        
        // Update dashboard stats
        await updateDashboardStats();
        
        AppState.isInitialized = true;
        console.log('‚úÖ Database initialized successfully!');
        
      } catch (error) {
        console.error('‚ùå Database initialization error:', error);
        showNotification('Database connection failed. Using offline mode.', 'warning');
      }
    }

    async function initializeSamplePackages() {
      // Sample packages data
      const samplePackages = [
        {
          tracking_number: 'FD26031998KR',
          status: 'awaiting_clearance',
          service_type: 'FedEx International Priority',
          current_location: 'FedEx Facility, Toronto, Canada',
          estimated_delivery: 'Pending clearance approval',
          ship_date: '2026-01-09',
          weight: '2840',
          dimensions: '72" x 84" x 48"',
          declared_value: 30000.00,
          contents: '$30,000 (high-value electronics & collectibles)',
          reference_number: 'HIGH-VALUE-SHIPMENT',
          insurance_coverage: 30000.00,
          progress_percentage: 20,
          requires_clearance: true,
          clearance_fee: 500,
          sender_name: 'Steven Venditti',
          sender_company: 'FedEx Office',
          sender_address: '1 Rocket Road',
          sender_city: 'Hawthorne, TX 90250, United States',
          sender_phone: '+1 (555) 123-4567',
          recipient_name: 'Steven Venditti',
          recipient_address: '32 Rory Road',
          recipient_city: 'Toronto, Ontario, Canada M6L 3G2',
          recipient_phone: '(555) 987-6543',
          recipient_email: 'stevenvenditti20@gmail.com'
        },
        {
          tracking_number: 'FX12345678US',
          status: 'in_transit',
          service_type: 'FedEx Ground',
          current_location: 'Memphis Hub, TN',
          estimated_delivery: '2025-01-15',
          ship_date: '2025-01-10',
          weight: '5.2',
          dimensions: '12" x 10" x 8"',
          declared_value: 150.00,
          contents: 'Electronics',
          reference_number: 'ORD-12345',
          insurance_coverage: 150.00,
          progress_percentage: 65,
          requires_clearance: false,
          sender_name: 'John Smith',
          sender_company: 'Tech Solutions Inc',
          sender_address: '123 Tech Street',
          sender_city: 'San Francisco, CA 94105, USA',
          sender_phone: '(415) 555-0199',
          recipient_name: 'Sarah Johnson',
          recipient_address: '456 Oak Avenue',
          recipient_city: 'Austin, TX 78701, USA',
          recipient_phone: '(512) 555-0123',
          recipient_email: 'sarah@example.com'
        }
      ];

      // Insert packages
      for (const pkg of samplePackages) {
        const { error } = await supabase
          .from('packages')
          .upsert(pkg, { onConflict: 'tracking_number' });
        
        if (error) {
          console.error('Error inserting package:', error);
        }
      }

      // Sample tracking events
      const trackingEvents = [
        {
          tracking_number: 'FD26031998KR',
          status: 'awaiting_clearance',
          location: 'TORONTO, CA',
          event_date: '2026-01-10',
          event_time: '08:30:00',
          description: 'Shipment is currently on hold pending recipient clearance approval prior to final processing and residential delivery.',
          is_latest: true,
          event_type: 'clearance'
        },
        {
          tracking_number: 'FD26031998KR',
          status: 'registered',
          location: 'TORONTO, CA',
          event_date: '2026-01-09',
          event_time: '13:45:00',
          description: 'Package has been registered at the FedEx facility and secured. Awaiting recipient clearance for processing.',
          is_latest: false,
          event_type: 'status_update'
        },
        {
          tracking_number: 'FX12345678US',
          status: 'in_transit',
          location: 'MEMPHIS, TN',
          event_date: '2025-01-12',
          event_time: '08:30:00',
          description: 'Package departed Memphis Hub facility',
          is_latest: true,
          event_type: 'status_update'
        }
      ];

      // Insert tracking events
      for (const event of trackingEvents) {
        const { error } = await supabase
          .from('tracking_events')
          .upsert(event, { onConflict: 'tracking_number,event_date,event_time' });
        
        if (error) {
          console.error('Error inserting tracking event:', error);
        }
      }
    }

    async function initializeSampleLocations() {
      const sampleLocations = [
        {
          name: 'FedEx Office - Downtown',
          address: '123 Main Street',
          city: 'Anytown',
          state: 'ST',
          zip_code: '12345',
          phone: '(555) 123-4567',
          hours: 'Mon-Fri 8AM-9PM',
          location_type: 'office',
          services: ['shipping', 'printing', 'packaging']
        },
        {
          name: 'FedEx Ship Center',
          address: '456 Business Ave',
          city: 'Anytown',
          state: 'ST',
          zip_code: '12345',
          phone: '(555) 987-6543',
          hours: 'Mon-Fri 7AM-7PM',
          location_type: 'ship_center',
          services: ['shipping', 'packaging', 'returns']
        },
        {
          name: 'FedEx Office - Mall Location',
          address: '789 Shopping Center Dr',
          city: 'Anytown',
          state: 'ST',
          zip_code: '12345',
          phone: '(555) 456-7890',
          hours: 'Mon-Sat 9AM-9PM, Sun 10AM-6PM',
          location_type: 'office',
          services: ['shipping', 'printing', 'packaging', 'copies']
        }
      ];

      for (const location of sampleLocations) {
        const { error } = await supabase
          .from('locations')
          .upsert(location, { onConflict: 'name,address' });
        
        if (error) {
          console.error('Error inserting location:', error);
        }
      }
    }

    async function initializeFAQData() {
      const faqData = [
        {
          question: 'How do I track my package?',
          answer: 'Enter your tracking number on the Track page to view real-time updates and detailed shipping information.',
          category: 'tracking',
          display_order: 1
        },
        {
          question: 'What is a clearance request?',
          answer: 'Some international shipments require recipient verification and approval before they can proceed to their destination.',
          category: 'clearance',
          display_order: 2
        },
        {
          question: 'How can I schedule a pickup?',
          answer: 'Use the Ship modal to schedule a pickup at your convenience. Our drivers will collect your packages.',
          category: 'shipping',
          display_order: 3
        },
        {
          question: 'What shipping services do you offer?',
          answer: 'We offer Express, Ground, Freight, and International shipping services with various delivery options.',
          category: 'services',
          display_order: 4
        },
        {
          question: 'How can I get shipping rates?',
          answer: 'Use our rate calculator in the Ship section or contact customer service for detailed pricing information.',
          category: 'pricing',
          display_order: 5
        }
      ];

      for (const faq of faqData) {
        const { error } = await supabase
          .from('faqs')
          .upsert(faq, { onConflict: 'question' });
        
        if (error) {
          console.error('Error inserting FAQ:', error);
        }
      }
    }

    // üì° REAL-TIME SUBSCRIPTIONS
    function setupRealTimeSubscriptions() {
      console.log('üì° Setting up real-time subscriptions...');

      // Subscribe to package updates
      const packageSubscription = supabase
        .channel('packages_channel')
        .on(
          'postgres_changes',
          { event: '*', schema: 'public', table: 'packages' },
          (payload) => {
            console.log('üì¶ Package update:', payload);
            handlePackageUpdate(payload);
          }
        )
        .subscribe();

      // Subscribe to tracking events
      const eventsSubscription = supabase
        .channel('tracking_events_channel')
        .on(
          'postgres_changes',
          { event: '*', schema: 'public', table: 'tracking_events' },
          (payload) => {
            console.log('üìç Tracking event update:', payload);
            handleTrackingEventUpdate(payload);
          }
        )
        .subscribe();

      // Subscribe to clearance requests
      const clearanceSubscription = supabase
        .channel('clearance_requests_channel')
        .on(
          'postgres_changes',
          { event: '*', schema: 'public', table: 'clearance_requests' },
          (payload) => {
            console.log('üîê Clearance request update:', payload);
            handleClearanceUpdate(payload);
          }
        )
        .subscribe();

      AppState.subscriptions = [packageSubscription, eventsSubscription, clearanceSubscription];
    }

    function handlePackageUpdate(payload) {
      // Update dashboard stats
      updateDashboardStats();
      
      // Show notification for status changes
      if (payload.eventType === 'UPDATE') {
        const pkg = payload.new;
        showNotification(`Package ${pkg.tracking_number} status updated: ${pkg.status.replace('_', ' ').toUpperCase()}`, 'info');
      }
    }

    function handleTrackingEventUpdate(payload) {
      // If tracking modal is open and matches this package, refresh content
      const modal = document.getElementById('tracking-modal');
      const trackingNumber = document.getElementById('modal-tracking-number').textContent;
      
      if (!modal.classList.contains('hidden') && payload.new.tracking_number === trackingNumber) {
        refreshTrackingModal(trackingNumber);
      }
    }

    function handleClearanceUpdate(payload) {
      if (payload.eventType === 'INSERT') {
        showNotification('Clearance request submitted successfully!', 'success');
        updateDashboardStats();
      }
    }

    // üìä DASHBOARD STATS UPDATE
    async function updateDashboardStats() {
      try {
        // Count active packages
        const { count: activePackages } = await supabase
          .from('packages')
          .select('*', { count: 'exact', head: true })
          .neq('status', 'delivered');

        // Count clearance requests
        const { count: clearanceRequests } = await supabase
          .from('clearance_requests')
          .select('*', { count: 'exact', head: true })
          .eq('status', 'pending');

        // Count delivered today
        const today = new Date().toISOString().split('T')[0];
        const { count: deliveredToday } = await supabase
          .from('packages')
          .select('*', { count: 'exact', head: true })
          .eq('status', 'delivered')
          .gte('updated_at', today);

        // Count locations
        const { count: locationsCount } = await supabase
          .from('locations')
          .select('*', { count: 'exact', head: true });

        // Update UI
        document.getElementById('active-packages-count').textContent = activePackages || 0;
        document.getElementById('clearance-requests-count').textContent = clearanceRequests || 0;
        document.getElementById('delivered-today-count').textContent = deliveredToday || 0;
        document.getElementById('locations-count').textContent = locationsCount || 0;

      } catch (error) {
        console.error('Error updating dashboard stats:', error);
      }
    }

    // üîç TRACKING FUNCTIONS WITH DATABASE INTEGRATION
    async function trackPackage(trackingNumber) {
      try {
        // Show loading state
        const modalContent = document.getElementById('modal-content');
        const trackingNumberElement = document.getElementById('modal-tracking-number');
        
        trackingNumberElement.textContent = trackingNumber;
        modalContent.innerHTML = `
          <div class="flex justify-center items-center py-12">
            <div class="loading-spinner mr-3"></div>
            <span>Loading package information...</span>
          </div>
        `;

        // Fetch package data from database
        const { data: packageData, error: packageError } = await supabase
          .from('packages')
          .select('*')
          .eq('tracking_number', trackingNumber.toUpperCase())
          .single();

        if (packageError) {
          throw new Error('Package not found');
        }

        // Fetch tracking events
        const { data: events, error: eventsError } = await supabase
          .from('tracking_events')
          .select('*')
          .eq('tracking_number', trackingNumber.toUpperCase())
          .order('event_date', { ascending: false })
          .order('event_time', { ascending: false });

        if (eventsError) {
          console.error('Error fetching events:', eventsError);
        }

        // Combine data and display
        const fullPackageData = {
          ...packageData,
          timeline: events || []
        };

        displayTrackingModal(fullPackageData);
        return true;

      } catch (error) {
        console.error('Error tracking package:', error);
        
        // Show error in modal
        const modalContent = document.getElementById('modal-content');
        modalContent.innerHTML = `
          <div class="text-center py-12">
            <i class="fas fa-exclamation-triangle text-fedex-orange text-4xl mb-4"></i>
            <h3 class="text-xl font-bold text-fedex-dark-gray mb-2">Package Not Found</h3>
            <p class="text-fedex-gray">The tracking number "${trackingNumber}" could not be found in our system.</p>
            <p class="text-fedex-gray mt-2">Please check the tracking number and try again.</p>
          </div>
        `;
        return false;
      }
    }

    function displayTrackingModal(data) {
      const modalContent = document.getElementById('modal-content');
      modalContent.innerHTML = generateTrackingContent(data);
      showModal('tracking-modal');
    }

    async function refreshTrackingModal(trackingNumber) {
      await trackPackage(trackingNumber);
    }

    function generateTrackingContent(data) {
      const progressSteps = [
        { name: 'Registered', icon: 'check', status: getStepStatus('registered', data.status) },
        { name: 'Awaiting Clearance', icon: 'clipboard-check', status: getStepStatus('awaiting_clearance', data.status) },
        { name: 'In Transit', icon: 'plane', status: getStepStatus('in_transit', data.status) },
        { name: 'Out for Delivery', icon: 'truck', status: getStepStatus('out_for_delivery', data.status) },
        { name: 'Delivered', icon: 'home', status: getStepStatus('delivered', data.status) }
      ];

      const statusClass = getStatusClass(data.status);

      return `
        <!-- Status Section -->
        <div class="bg-fedex-light-gray rounded-lg p-4 sm:p-6 mb-6">
          <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center space-y-4 lg:space-y-0 mb-6">
            <div>
              <div class="flex items-center space-x-3 mb-3">
                <span class="status-badge ${statusClass}">
                  <i class="fas fa-${getStatusIcon(data.status)} mr-2"></i>${formatStatus(data.status)}
                </span>
                <span class="text-fedex-gray text-sm sm:text-base">${data.service_type}</span>
              </div>
              <p class="text-fedex-dark-gray font-semibold text-base sm:text-lg">Expected delivery: ${data.estimated_delivery}</p>
              <p class="text-fedex-gray text-sm sm:text-base">Currently at: ${data.current_location}</p>
            </div>
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3 w-full sm:w-auto">
              <button onclick="generatePDF('${data.tracking_number}')" class="fedex-button text-white px-4 sm:px-6 py-3 rounded-lg font-semibold text-sm sm:text-base w-full sm:w-auto">
                <i class="fas fa-file-pdf mr-2"></i>Download Receipt
              </button>
              <button onclick="requestEmailUpdates('${data.tracking_number}')" class="border border-fedex-purple text-fedex-purple px-4 sm:px-6 py-3 rounded-lg font-semibold hover:bg-fedex-purple hover:text-white transition-colors text-sm sm:text-base w-full sm:w-auto">
                <i class="fas fa-envelope mr-2"></i>Email Updates
              </button>
              ${data.requires_clearance ? `
              <button onclick="openClearanceModal('${data.tracking_number}')" class="bg-fedex-blue text-white px-4 sm:px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors text-sm sm:text-base w-full sm:w-auto">
                <i class="fas fa-unlock mr-2"></i>Request Clearance
              </button>
              ` : ''}
            </div>
          </div>

          <!-- Progress Bar -->
          <div class="mb-4">
            <div class="flex justify-between text-sm text-fedex-gray mb-2">
              <span>Shipment Progress</span>
              <span>${data.progress_percentage}% Complete</span>
            </div>
            <div class="progress-container">
              <div class="progress-bar" style="width: ${data.progress_percentage}%"></div>
            </div>
          </div>

          ${data.requires_clearance && data.status === 'awaiting_clearance' ? `
          <!-- Clearance Notice -->
          <div class="clearance-notice rounded-lg p-4">
            <div class="flex items-start space-x-3">
              <i class="fas fa-info-circle text-yellow-600 text-xl mt-1"></i>
              <div>
                <h4 class="font-bold text-yellow-800 mb-2">Important Notice</h4>
                <p class="text-yellow-700 text-sm">
                  This shipment has been successfully registered at a FedEx facility.<br><br>
                  Processing and final delivery are pending recipient clearance authorization.
                  A clearance fee of $500 is required to release the shipment for processing and residential delivery to the listed address.<br><br>
                  Once clearance is completed, the shipment will proceed to final routing and delivery.<br><br>
                  For clearance, please contact: <a href="mailto:helpfedexparcel@gmail.com" class="text-fedex-blue hover:underline font-semibold">helpfedexparcel@gmail.com</a>
                </p>
              </div>
            </div>
          </div>
          ` : ''}
        </div>

        <!-- Progress Steps -->
        <div class="mb-8">
          <h3 class="text-lg sm:text-xl font-bold text-fedex-dark-gray mb-6">Shipment Journey</h3>
          <div class="grid grid-cols-2 sm:grid-cols-5 gap-2 sm:gap-4">
            ${progressSteps.map(step => `
              <div class="progress-step ${step.status} text-center">
                <div class="w-8 h-8 sm:w-12 sm:h-12 ${step.status === 'completed' ? 'bg-fedex-green' : step.status === 'current' ? 'bg-fedex-orange' : 'bg-gray-300'} rounded-full flex items-center justify-center mx-auto mb-2 relative z-10">
                  <i class="fas fa-${step.icon} text-white text-xs sm:text-base"></i>
                </div>
                <h4 class="font-semibold ${step.status ? 'text-fedex-dark-gray' : 'text-gray-400'} text-xs sm:text-sm">${step.name}</h4>
              </div>
            `).join('')}
          </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-8">
          <!-- Timeline -->
          <div>
            <h3 class="text-lg sm:text-xl font-bold text-fedex-dark-gray mb-6">Shipment Timeline</h3>
            <div class="relative">
              ${data.timeline.map((event, index) => `
                <div class="timeline-item mb-6 pl-4 sm:pl-6 relative">
                  <div class="timeline-dot ${event.is_latest ? 'bg-fedex-orange' : 'bg-fedex-green'}"></div>
                  ${index < data.timeline.length - 1 ? '<div class="timeline-line"></div>' : ''}
                  <div class="bg-white border border-gray-200 rounded-lg p-3 sm:p-4">
                    <div class="flex justify-between items-start mb-2">
                      <h4 class="font-semibold text-fedex-dark-gray text-sm sm:text-base">${formatStatus(event.status)}</h4>
                      <span class="text-xs sm:text-sm text-fedex-gray">${event.is_latest ? 'Current' : 'Completed'}</span>
                    </div>
                    <p class="text-fedex-gray mb-1 text-sm">${event.location}</p>
                    <p class="text-xs sm:text-sm text-fedex-gray">${formatDate(event.event_date)} ${event.event_time}</p>
                    <p class="text-xs sm:text-sm text-fedex-gray mt-2">${event.description}</p>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>

          <!-- Details Panel -->
          <div>
            <!-- Package Details -->
            <div class="bg-white border border-gray-200 rounded-lg p-4 sm:p-6 mb-6">
              <h3 class="text-lg sm:text-xl font-bold text-fedex-dark-gray mb-4">Package Details</h3>
              <div class="space-y-3 text-sm sm:text-base">
                <div class="flex justify-between">
                  <span class="text-fedex-gray">Service:</span>
                  <span class="font-semibold">${data.service_type}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-fedex-gray">Weight:</span>
                  <span class="font-semibold">${data.weight} lbs</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-fedex-gray">Dimensions:</span>
                  <span class="font-semibold">${data.dimensions}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-fedex-gray">Declared Value:</span>
                  <span class="font-semibold text-fedex-orange">$${data.declared_value.toLocaleString()}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-fedex-gray">Contents:</span>
                  <span class="font-semibold">${data.contents}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-fedex-gray">Clearance Fee:</span>
                  <span class="font-semibold text-fedex-orange">$${data.clearance_fee || 500}</span>
                </div>
              </div>
            </div>

            <!-- Addresses -->
            <div class="bg-white border border-gray-200 rounded-lg p-4 sm:p-6 mb-6">
              <h3 class="text-lg sm:text-xl font-bold text-fedex-dark-gray mb-4">Shipping Information</h3>
              <div class="space-y-4 text-sm sm:text-base">
                <div>
                  <h4 class="font-semibold text-fedex-gray mb-2">From:</h4>
                  <p class="text-fedex-dark-gray font-semibold">${data.sender_name}</p>
                  <p class="text-fedex-gray">${data.sender_company}</p>
                  <p class="text-fedex-gray">${data.sender_address}</p>
                  <p class="text-fedex-gray">${data.sender_city}</p>
                  <p class="text-fedex-gray">Phone: ${data.sender_phone}</p>
                </div>
                <div>
                  <h4 class="font-semibold text-fedex-gray mb-2">To:</h4>
                  <p class="text-fedex-dark-gray font-semibold">${data.recipient_name}</p>
                  <p class="text-fedex-gray">${data.recipient_address}</p>
                  <p class="text-fedex-gray">${data.recipient_city}</p>
                  <p class="text-fedex-gray">Phone: ${data.recipient_phone}</p>
                  <p class="text-fedex-gray">Email: ${data.recipient_email}</p>
                </div>
              </div>
            </div>

            <!-- Map -->
            <div class="bg-white border border-gray-200 rounded-lg p-4 sm:p-6">
              <h3 class="text-lg sm:text-xl font-bold text-fedex-dark-gray mb-4">
                <i class="fas fa-map-marker-alt mr-2 text-fedex-orange"></i>Package Journey
              </h3>
              <div class="map-container rounded-lg overflow-hidden" style="height: 250px;">
                <div class="relative w-full h-full">
                  <div class="route-line"></div>
                  <div class="route-marker origin"></div>
                  <div class="route-marker current"></div>
                  <div class="route-marker destination"></div>

                  <div class="absolute top-4 left-4 bg-white px-2 sm:px-3 py-1 rounded-full text-xs sm:text-sm font-semibold text-fedex-purple shadow">
                    <i class="fas fa-map-pin mr-1"></i> Origin
                  </div>
                  <div class="absolute top-4 right-4 bg-white px-2 sm:px-3 py-1 rounded-full text-xs sm:text-sm font-semibold text-fedex-green shadow">
                    <i class="fas fa-home mr-1"></i> Destination
                  </div>

                  <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-white px-2 sm:px-4 py-2 rounded-lg shadow text-center">
                    <div class="text-xs text-fedex-gray">Current Progress</div>
                    <div class="font-bold text-fedex-dark-gray text-sm">${data.progress_percentage}% Complete</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        ${data.declared_value > 1000 ? `
        <!-- High-Value Notice -->
        <div class="mt-8 bg-red-50 border border-red-200 rounded-lg p-4 sm:p-6">
          <div class="flex items-start space-x-3">
            <i class="fas fa-shield-alt text-red-600 text-xl mt-1"></i>
            <div>
              <h4 class="font-semibold text-red-800 mb-2">High-Value Shipment</h4>
              <p class="text-red-700 text-sm">
                This shipment contains high-value items ($${data.declared_value.toLocaleString()}) and requires special handling procedures. 
                ${data.requires_clearance ? 'Clearance approval and identity verification are mandatory before shipping can proceed.' : ''}
              </p>
            </div>
          </div>
        </div>
        ` : ''}
      `;
    }

    // üìù FORM SUBMISSION FUNCTIONS
    async function submitClearanceRequest(formData, trackingNumber) {
      try {
        const clearanceData = {
          tracking_number: trackingNumber,
          full_name: formData.get('full_name'),
          email: formData.get('email'),
          phone: formData.get('phone'),
          address: formData.get('address'),
          notes: formData.get('notes'),
          status: 'pending',
          submitted_at: new Date().toISOString()
        };

        const { data, error } = await supabase
          .from('clearance_requests')
          .insert([clearanceData])
          .select();

        if (error) throw error;

        // Update package status to indicate clearance request submitted
        const { error: updateError } = await supabase
          .from('packages')
          .update({ 
            clearance_requested: true,
            updated_at: new Date().toISOString() 
          })
          .eq('tracking_number', trackingNumber);

        if (updateError) {
          console.error('Error updating package:', updateError);
        }

        return { success: true, data };

      } catch (error) {
        console.error('Error submitting clearance request:', error);
        return { success: false, error };
      }
    }

    async function submitContactForm(formData) {
      try {
        const contactData = {
          full_name: formData.get('full_name'),
          email: formData.get('email'),
          subject: formData.get('subject'),
          message: formData.get('message'),
          submitted_at: new Date().toISOString(),
          status: 'new'
        };

        const { data, error } = await supabase
          .from('contact_messages')
          .insert([contactData])
          .select();

        if (error) throw error;

        return { success: true, data };

      } catch (error) {
        console.error('Error submitting contact form:', error);
        return { success: false, error };
      }
    }

    async function createNewShipment() {
      // Generate a new tracking number
      const trackingNumber = generateTrackingNumber();
      
      const newPackage = {
        tracking_number: trackingNumber,
        status: 'registered',
        service_type: 'FedEx Ground',
        current_location: 'Origin Facility',
        estimated_delivery: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
        ship_date: new Date().toISOString().split('T')[0],
        weight: '5.0',
        dimensions: '12" x 10" x 8"',
        declared_value: 100.00,
        contents: 'General Merchandise',
        reference_number: 'NEW-' + Math.random().toString(36).substr(2, 9).toUpperCase(),
        progress_percentage: 5,
        requires_clearance: false,
        sender_name: 'Demo Sender',
        sender_company: 'Demo Company',
        sender_address: '123 Demo Street',
        sender_city: 'Demo City, ST 12345, USA',
        sender_phone: '(555) 123-4567',
        recipient_name: 'Demo Recipient',
        recipient_address: '456 Recipient Ave',
        recipient_city: 'Target City, ST 67890, USA',
        recipient_phone: '(555) 987-6543',
        recipient_email: 'demo@example.com'
      };

      try {
        const { data, error } = await supabase
          .from('packages')
          .insert([newPackage])
          .select();

        if (error) throw error;

        // Add initial tracking event
        const initialEvent = {
          tracking_number: trackingNumber,
          status: 'registered',
          location: 'ORIGIN FACILITY',
          event_date: new Date().toISOString().split('T')[0],
          event_time: new Date().toTimeString().split(' ')[0],
          description: 'Package registered and ready for shipment',
          is_latest: true,
          event_type: 'status_update'
        };

        await supabase.from('tracking_events').insert([initialEvent]);

        showNotification(`New shipment created: ${trackingNumber}`, 'success');
        closeModal('ship-modal');

        // Auto-track the new package
        setTimeout(() => {
          document.getElementById('tracking-number').value = trackingNumber;
          trackPackage(trackingNumber);
        }, 1000);

      } catch (error) {
        console.error('Error creating shipment:', error);
        showNotification('Error creating shipment. Please try again.', 'error');
      }
    }

    async function searchLocations(query = '') {
      try {
        let queryBuilder = supabase.from('locations').select('*');
        
        if (query.trim()) {
          queryBuilder = queryBuilder.or(`name.ilike.%${query}%,city.ilike.%${query}%,address.ilike.%${query}%,zip_code.eq.${query}`);
        }

        const { data: locations, error } = await queryBuilder
          .order('name', { ascending: true })
          .limit(20);

        if (error) throw error;

        const resultsContainer = document.getElementById('location-results');
        resultsContainer.innerHTML = '';

        if (locations.length === 0) {
          resultsContainer.innerHTML = '<p class="text-fedex-gray text-center col-span-2">No locations found matching your search.</p>';
          return;
        }

        locations.forEach(location => {
          const locationCard = document.createElement('div');
          locationCard.className = 'border border-gray-200 rounded-lg p-4 service-card';
          locationCard.innerHTML = `
            <h3 class="font-bold text-fedex-dark-gray mb-2">${location.name}</h3>
            <p class="text-fedex-gray text-sm">${location.address}</p>
            <p class="text-fedex-gray text-sm">${location.city}, ${location.state} ${location.zip_code}</p>
            <p class="text-fedex-gray text-sm">Phone: ${location.phone}</p>
            <p class="text-fedex-gray text-sm">Hours: ${location.hours}</p>
            <div class="mt-2">
              ${location.services.map(service => `<span class="inline-block bg-fedex-light-gray text-fedex-dark-gray px-2 py-1 rounded text-xs mr-1 mb-1">${service}</span>`).join('')}
            </div>
          `;
          resultsContainer.appendChild(locationCard);
        });

      } catch (error) {
        console.error('Error searching locations:', error);
        const resultsContainer = document.getElementById('location-results');
        resultsContainer.innerHTML = '<p class="text-red-500 text-center col-span-2">Error loading locations. Please try again.</p>';
      }
    }

    async function loadFAQData() {
      try {
        const { data: faqs, error } = await supabase
          .from('faqs')
          .select('*')
          .order('display_order', { ascending: true });

        if (error) throw error;

        const faqContainer = document.getElementById('faq-container');
        faqContainer.innerHTML = '';

        faqs.forEach(faq => {
          const faqItem = document.createElement('div');
          faqItem.className = 'faq-item p-3';
          faqItem.onclick = () => toggleFaq(faqItem);
          faqItem.innerHTML = `
            <div class="flex justify-between items-center">
              <h4 class="font-semibold text-fedex-dark-gray">${faq.question}</h4>
              <i class="fas fa-chevron-down text-fedex-gray"></i>
            </div>
            <div class="faq-answer text-fedex-gray text-sm mt-2">
              ${faq.answer}
            </div>
          `;
          faqContainer.appendChild(faqItem);
        });

      } catch (error) {
        console.error('Error loading FAQ data:', error);
      }
    }

    // üîß UTILITY FUNCTIONS
    function generateTrackingNumber() {
      const prefixes = ['FX', 'FD', 'GD', 'HD'];
      const prefix = prefixes[Math.floor(Math.random() * prefixes.length)];
      const numbers = Math.random().toString().substr(2, 8);
      const suffix = Math.random().toString(36).substr(2, 2).toUpperCase();
      return `${prefix}${numbers}${suffix}`;
    }

    function getStepStatus(stepStatus, currentStatus) {
      const statusOrder = ['registered', 'awaiting_clearance', 'in_transit', 'out_for_delivery', 'delivered'];
      const stepIndex = statusOrder.indexOf(stepStatus);
      const currentIndex = statusOrder.indexOf(currentStatus);
      
      if (stepIndex < currentIndex) return 'completed';
      if (stepIndex === currentIndex) return 'current';
      return '';
    }

    function getStatusClass(status) {
      const statusClasses = {
        'registered': 'status-registered',
        'awaiting_clearance': 'status-awaiting-clearance',
        'in_transit': 'status-in-transit',
        'out_for_delivery': 'status-in-transit',
        'delivered': 'status-delivered'
      };
      return statusClasses[status] || 'status-registered';
    }

    function getStatusIcon(status) {
      const statusIcons = {
        'registered': 'check-circle',
        'awaiting_clearance': 'clock',
        'in_transit': 'truck',
        'out_for_delivery': 'shipping-fast',
        'delivered': 'check-circle'
      };
      return statusIcons[status] || 'info-circle';
    }

    function formatStatus(status) {
      return status.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }

    function formatDate(dateString) {
      return new Date(dateString).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    }

    // Previous utility functions (showNotification, modal functions, etc.)
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.setAttribute('role', 'alert');
      notification.innerHTML = `
        <div class="flex items-center">
          <i class="fas fa-${getNotificationIcon(type)} mr-2"></i>
          <span>${message}</span>
        </div>
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideInRight 0.5s ease-out reverse';
        setTimeout(() => notification.remove(), 500);
      }, 4000);
    }

    function getNotificationIcon(type) {
      const icons = {
        success: 'check-circle',
        error: 'exclamation-circle',
        warning: 'exclamation-triangle',
        info: 'info-circle'
      };
      return icons[type] || 'info-circle';
    }

    // Page and Modal Functions
    function showPage(pageId) {
      document.querySelectorAll('.page-section').forEach(page => {
        page.classList.remove('active');
      });
      
      const targetPage = document.getElementById(pageId + '-page');
      if (targetPage) {
        targetPage.classList.add('active');
        AppState.currentPage = pageId;
      }
      
      hideMobileMenu();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function showModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        modal.querySelector('.modal-content').focus();
      }
      hideMobileMenu();
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }
    }

    function toggleMobileMenu() {
      const mobileMenu = document.getElementById('mobile-menu');
      mobileMenu.classList.toggle('hidden');
    }

    function hideMobileMenu() {
      const mobileMenu = document.getElementById('mobile-menu');
      mobileMenu.classList.add('hidden');
    }

    function showTab(tabId) {
      const tabs = document.querySelectorAll('.tab-content');
      const buttons = document.querySelectorAll('.tab-button');
      
      tabs.forEach(tab => tab.classList.remove('active'));
      buttons.forEach(btn => btn.classList.remove('active'));
      
      const targetTab = document.getElementById(tabId);
      const targetButton = document.querySelector(`[data-tab="${tabId}"]`);
      
      if (targetTab) targetTab.classList.add('active');
      if (targetButton) targetButton.classList.add('active');
    }

    function toggleFaq(element) {
      const answer = element.querySelector('.faq-answer');
      const icon = element.querySelector('.fa-chevron-down');
      
      answer.classList.toggle('active');
      icon.classList.toggle('fa-chevron-down');
      icon.classList.toggle('fa-chevron-up');
    }

    function validateForm(form) {
      const inputs = form.querySelectorAll('input[required], textarea[required], select[required]');
      let isValid = true;

      inputs.forEach(input => {
        const errorMessage = input.nextElementSibling?.classList.contains('error-text') ? input.nextElementSibling : null;
        
        if (!input.value.trim()) {
          isValid = false;
          input.classList.add('border-red-500');
          if (!errorMessage) {
            const error = document.createElement('p');
            error.className = 'error-text text-red-500 text-sm mt-1';
            error.textContent = `${input.name || 'This field'} is required`;
            input.parentNode.appendChild(error);
          }
        } else {
          input.classList.remove('border-red-500');
          if (errorMessage) errorMessage.remove();
        }

        if (input.type === 'email' && input.value.trim()) {
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(input.value)) {
            isValid = false;
            input.classList.add('border-red-500');
            if (!errorMessage) {
              const error = document.createElement('p');
              error.className = 'error-text text-red-500 text-sm mt-1';
              error.textContent = 'Please enter a valid email address';
              input.parentNode.appendChild(error);
            }
          }
        }
      });

      return isValid;
    }

    // Additional Functions
    function requestEmailUpdates(trackingNumber) {
      showNotification(`Email updates enabled for ${trackingNumber}`, 'success');
    }

    function openClearanceModal(trackingNumber) {
      document.getElementById('clearance-tracking-number').value = trackingNumber;
      showModal('clearance-modal');
    }

    function closeClearanceModal() {
      closeModal('clearance-modal');
    }

    function openLiveChat() {
      showModal('chat-modal');
    }

    function sendChatMessage(message) {
      const messagesContainer = document.getElementById('chat-messages');
      
      const userMessage = document.createElement('div');
      userMessage.className = 'mb-4 text-right';
      userMessage.innerHTML = `
        <div class="bg-fedex-purple text-white rounded-lg p-3 inline-block max-w-xs">
          <p class="text-sm">${message}</p>
        </div>
      `;
      messagesContainer.appendChild(userMessage);
      
      setTimeout(() => {
        const agentMessage = document.createElement('div');
        agentMessage.className = 'mb-4';
        agentMessage.innerHTML = `
          <div class="bg-gray-100 rounded-lg p-3 max-w-xs">
            <p class="text-sm"><strong>Support Agent:</strong> Thank you for your message. How can I assist you further with your shipment?</p>
          </div>
        `;
        messagesContainer.appendChild(agentMessage);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }, 1000);
      
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function generatePDF(trackingNumber) {
      // Simplified PDF generation for demo
      showNotification('PDF receipt downloaded successfully!', 'success');
    }

    // üöÄ EVENT LISTENERS AND INITIALIZATION
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('üöÄ FedEx Live Tracking System Starting...');
      
      // Initialize database and load sample data
      await initializeDatabase();
      
      // Load FAQ data
      await loadFAQData();
      
      // Initialize location search
      await searchLocations('');
      
      setupEventListeners();
      
      console.log('‚úÖ FedEx System Ready - All systems operational!');
      showNotification('FedEx Live Tracking System Ready', 'success');
    });

    function setupEventListeners() {
      // Tracking form
      const trackingForm = document.getElementById('tracking-form');
      trackingForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const trackingNumber = document.getElementById('tracking-number').value.trim();
        const trackButton = document.getElementById('track-button');
        const trackText = document.getElementById('track-text');
        const trackLoading = document.getElementById('track-loading');
        
        if (!trackingNumber) {
          showNotification('Please enter a tracking number', 'error');
          return;
        }
        
        trackText.classList.add('hidden');
        trackLoading.classList.remove('hidden');
        trackButton.disabled = true;
        
        const found = await trackPackage(trackingNumber);
        
        if (found) {
          showModal('tracking-modal');
        } else {
          showNotification('Tracking number not found. Please check and try again.', 'error');
        }
        
        trackText.classList.remove('hidden');
        trackLoading.classList.add('hidden');
        trackButton.disabled = false;
      });

      // Clearance form
      const clearanceForm = document.getElementById('clearance-form');
      clearanceForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!validateForm(this)) return;
        
        const submitText = document.getElementById('clearance-submit-text');
        const submitLoading = document.getElementById('clearance-submit-loading');
        
        submitText.classList.add('hidden');
        submitLoading.classList.remove('hidden');
        
        const formData = new FormData(this);
        const trackingNumber = document.getElementById('clearance-tracking-number').value;
        
        const result = await submitClearanceRequest(formData, trackingNumber);
        
        if (result.success) {
          showNotification('Clearance request submitted successfully!', 'success');
          closeClearanceModal();
          this.reset();
        } else {
          showNotification('Error submitting request. Please try again.', 'error');
        }
        
        submitText.classList.remove('hidden');
        submitLoading.classList.add('hidden');
      });

      // Contact form
      const contactForm = document.getElementById('contact-form');
      contactForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!validateForm(this)) return;
        
        const submitText = document.getElementById('contact-submit-text');
        const submitLoading = document.getElementById('contact-submit-loading');
        
        submitText.classList.add('hidden');
        submitLoading.classList.remove('hidden');
        
        const formData = new FormData(this);
        const result = await submitContactForm(formData);
        
        if (result.success) {
          showNotification('Message sent successfully! We will respond within 24 hours.', 'success');
          this.reset();
        } else {
          showNotification('Error sending message. Please try again.', 'error');
        }
        
        submitText.classList.remove('hidden');
        submitLoading.classList.add('hidden');
      });

      // Ship calculator form
      const shipCalculatorForm = document.getElementById('ship-calculator-form');
      shipCalculatorForm.addEventListener('submit', function(e) {
        e.preventDefault();
        if (validateForm(this)) {
          const estimatedRate = '$' + (Math.random() * 50 + 15).toFixed(2);
          showNotification(`Estimated shipping rate: ${estimatedRate}`, 'success');
        }
      });

      // Location search form
      const locationSearchForm = document.getElementById('location-search-form');
      locationSearchForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const searchText = document.getElementById('location-search-text');
        const searchLoading = document.getElementById('location-search-loading');
        
        searchText.classList.add('hidden');
        searchLoading.classList.remove('hidden');
        
        const query = document.getElementById('location-input').value.trim();
        await searchLocations(query);
        showNotification(`Showing locations ${query ? `for "${query}"` : 'in your area'}`, 'info');
        
        searchText.classList.remove('hidden');
        searchLoading.classList.add('hidden');
      });

      // Chat form
      const chatForm = document.getElementById('chat-form');
      chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const input = document.getElementById('chat-input');
        const message = input.value.trim();
        
        if (message) {
          sendChatMessage(message);
          input.value = '';
        }
      });

      // Modal close buttons
      document.getElementById('close-modal')?.addEventListener('click', () => closeModal('tracking-modal'));
      document.getElementById('close-clearance-modal')?.addEventListener('click', closeClearanceModal);
      document.getElementById('cancel-clearance')?.addEventListener('click', closeClearanceModal);

      // Keyboard shortcuts
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          document.querySelectorAll('.modal-backdrop').forEach(modal => {
            if (!modal.classList.contains('hidden')) {
              const modalId = modal.id;
              closeModal(modalId);
            }
          });
        }
      });

      // Window resize handler
      window.addEventListener('resize', function() {
        if (window.innerWidth >= 1024) {
          hideMobileMenu();
        }
      });
    }

    // Global function assignments
    window.showPage = showPage;
    window.showModal = showModal;
    window.closeModal = closeModal;
    window.toggleMobileMenu = toggleMobileMenu;
    window.hideMobileMenu = hideMobileMenu;
    window.trackPackage = trackPackage;
    window.generatePDF = generatePDF;
    window.requestEmailUpdates = requestEmailUpdates;
    window.openClearanceModal = openClearanceModal;
    window.closeClearanceModal = closeClearanceModal;
    window.openLiveChat = openLiveChat;
    window.showTab = showTab;
    window.toggleFaq = toggleFaq;
    window.createNewShipment = createNewShipment;
  </script>

</body></html>
